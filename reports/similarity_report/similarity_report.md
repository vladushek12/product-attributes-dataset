**Аннотация**: в рамках данной задачи модели необходимо определить какие характеристики описывают товарную позицию.

# Датасет

Для данной задачи был составлен датасет, который содержит в себе наименование товарной позиции, список характеристик в формате словаря и массив правильных ответ, где элемент - ключ из списка характеристик.\
Размер датасета равен 100 элементам.

# Модель

В рамках тестирования использовалась модель T-PRO 32b от Т-Банка.

# Процесс тестирования

Для выполнения данной задачи были расмотрены 2 подхода

## Подход 1

Необходимо написать те характеристики, которые присутствуют в названии товарной позиции.

### Zero-shot

#### Промпт

```python
SYSTEM_PROMPT = """
Напиши ключи из характеристики, которая присутствует в названии товара.

Следуй этим правилам:
- Характеристика должна быть полностью или частично представлена в товарной позиции.
- Включай в ответ ключи, для которых удалось найти соответвутствующий фрагмент в названии товара.

Выдай ответ в виде массива JSON.

**Не пиши больше ничего кроме ответа.**
""".strip()

USER_PROMPT = """
Название товара: {problem_title}
Характеристики: {problem_decomposition}
""".strip()
```

#### Результаты

```json
{
    "TP": 369,
    "FP": 159,
    "FN": 83,
    "Precision": 0.7,
    "Recall": 0.82,
    "F1-score": 0.75
}
```

F1 мера составляет всего лишь 0.75, что является неудовлетворительными результатом.

### Few-shot (3 примера)

#### Примеры

Примеры для данной задачи были подобраны такие:

```json
[
    {
        "title": "Карандаш чернографитный пластиковый НВ с ластиком Выбор есть заточенный шестигранный черный корпус (12 штук в наборе)",
        "attributes": {
            "Торговая марка": "Выбор есть",
            "Твердость грифеля": "HB",
            "Наличие ластика": "Да",
            "Заточенный": "Да",
            "Профиль карандаша": "шестигранный",
            "Материал корпуса": "пластик",
            "Цвет корпуса": "черный",
            "Длина корпуса карандаша": "185 мм",
            "Единица продажи": "упаковка",
            "Кол-во штук в единице продажи": "12",
            "Кол-во единиц продаж в промежуточной упаковке (кратность)": "6",
            "Количество единиц продаж в транспортной упаковке": "90",
            "Страна происхождения": "Россия"
        },
        "result": [
            "Торговая марка",
            "Наличие ластика",
            "Твердость грифеля",
            "Заточенный",
            "Профиль карандаша",
            "Цвет корпуса",
            "Кол-во штук в единице продажи"
        ]
    },
    {
        "title": "Сабо женские EVART Ола ЭВА серые (размер 39)",
        "attributes": {
            "Торговая марка": "Evart",
            "Коллекция": "Сабо ЭВА Ола",
            "Тип": "сабо",
            "Модель": "Ола",
            "Материал верха обуви": "ЭВА",
            "Пол": "женский",
            "Размер": "39",
            "Цвет": "серый",
            "Материал подошвы": "ЭВА",
            "Материал стельки": "отсутствует",
            "Стелька": "отсутствует",
            "Подносок": "нет",
            "Защитные свойства": "от общих загрязнений",
            "Метод крепления подошвы": "литьевой",
            "С ремешком": "да",
            "Перфорация": "Да",
            "Тип подошвы": "плоская",
            "Сфера применения": "медицина , пищевое производство и общественное питание , хорека",
            "Стандарты": "ТР ТС 017/2011",
            "Честный знак": "Да",
            "Количество единиц продаж в транспортной упаковке": "1",
            "Страна происхождения": "Россия",
            "Вес": "0.227 кг"
        },
        "result": [
            "Торговая марка",
            "Тип",
            "Модель",
            "Материал верха обуви",
            "Пол",
            "Размер",
            "Цвет",
            "Материал подошвы"
        ]
    },
    {
        "title": "Бумага для цветной лазерной печати Xerox Colotech + ( A4, 250 г/кв.м, 250 листов, 003R94671)",
        "attributes": {
            "Торговая марка": "Xerox Colotech +",
            "Покрытие": "без покрытия (каландрированная бумага)",
            "Плотность листа бумаги": "250 г/кв.м",
            "Белизна CIE": "161 ± 3%",
            "Формат листов": "А4",
            "Сертификация по экологическим стандартам": "Нет",
            "Яркость бумаги": "110",
            "Количество единиц продаж в транспортной упаковке": "144",
            "Кол-во единиц продаж в промежуточной упаковке (кратность)": "4",
            "Страна происхождения": "Австрия",
            "Количество листов в упаковке": "250 шт"
        },
        "result": [
            "Торговая марка",
            "Плотность листа бумаги",
            "Формат листов",
            "Количество листов в упаковке"
        ]
    }
]
```

#### Промпт

```python
SYSTEM_PROMPT = """
Напиши ключи из характеристики, которая присутствует в названии товара.

Примеры
{examples}

Следуй этим правилам:
- Характеристика должна быть полностью или частично представлена в товарной позиции.
- Включай в ответ ключи, для которых удалось найти соответвутствующий фрагмент в названии товара.

Выдай ответ в виде массива JSON.

**Не пиши больше ничего кроме ответа.**
""".strip()

USER_PROMPT = """
Название товара: {problem_title}
Характеристики: {problem_decomposition}
""".strip()
```

#### Результаты

```json
{
    "TP": 413,
    "FP": 55,
    "FN": 39,
    "Precision": 0.88,
    "Recall": 0.91,
    "F1-score": 0.9
}
```

В данном эксперименте наблюдается положительная тенденция по улучшению метрик.

### Few-shot (3 примера) и промпт на английском

#### Промпт

```python
SYSTEM_PROMPT = """
Write the keys from the characteristic that is present in the product name.

Examples:
{examples}


Pay attention to the strict implementation of these rules:
- The dictionary must consist only of dictionary keys, and the values ​​must be only fragments of the product item.
- Do not write those keys for which there is no match.
- Values ​​should not intersect between other values ​​in your answer.

Give the answer as a JSON array.

**Do not generate any text after the JSON output.**
""".strip()

USER_PROMPT = """
Give an answer for this:
Product title: {problem_title} 
Dictionary: {problem_decomposition}.
""".strip()
```

#### Результаты

```json
{
    "TP": 423,
    "FP": 91,
    "FN": 29,
    "Precision": 0.82,
    "Recall": 0.94,
    "F1-score": 0.88
}
```

F1 мера уменьшилась, относительно варианта промпта на русском языке, поэтому более не рассматриваем вариант промптов на английском.

### Few-shot (3 примера) с CoT

В рамках данного эскперимента просим порассуждать перед выдачей ответа

#### Промпт

```python
class SimilarityListResponse(BaseModel):
    reasoning: str = Field(..., description="Ход мыслей перед генерацией списка")
    attributes: List[str] = Field(..., description="Список ключей характеристик")

parser = PydanticOutputParser(pydantic_object=SimilarityListResponse)

SYSTEM_PROMPT = """
Напиши ключи из характеристики, которая присутствует в названии товара.

Примеры
{examples}

Следуй этим правилам:
- Характеристика должна быть полностью или частично представлена в товарной позиции.
- Характеристика должна иметь фрагмент строки для того чтобы понять, что она представлена в товарной позиции.
- Все ключи в ходе мыслей оборачивай в одинарные кавычки - 'текст'

**{format_instructions}**
""".strip()

USER_PROMPT = """
Название товара: {problem_title}
Характеристики: {problem_decomposition}
""".strip()
```

#### Результаты

```json
{
    "TP": 428,
    "FP": 74,
    "FN": 24,
    "Precision": 0.85,
    "Recall": 0.95,
    "F1-score": 0.9
}
```

Как можно увидеть, количество ответов увеличилось, но величина Precision уменьшилась.

### Few-shot (7 примеров)

#### Список примеров

```json
[
    {
        "title": "Карандаш чернографитный пластиковый НВ с ластиком Выбор есть заточенный шестигранный черный корпус (12 штук в наборе)",
        "attributes": {
            "Торговая марка": "Выбор есть",
            "Твердость грифеля": "HB",
            "Наличие ластика": "Да",
            "Заточенный": "Да",
            "Профиль карандаша": "шестигранный",
            "Материал корпуса": "пластик",
            "Цвет корпуса": "черный",
            "Длина корпуса карандаша": "185 мм",
            "Единица продажи": "упаковка",
            "Кол-во штук в единице продажи": "12",
            "Кол-во единиц продаж в промежуточной упаковке (кратность)": "6",
            "Количество единиц продаж в транспортной упаковке": "90",
            "Страна происхождения": "Россия"
        },
        "result": [
            "Торговая марка",
            "Наличие ластика",
            "Твердость грифеля",
            "Заточенный",
            "Профиль карандаша",
            "Цвет корпуса",
            "Кол-во штук в единице продажи"
        ]
    },
    {
        "title": "Сабо женские EVART Ола ЭВА серые (размер 39)",
        "attributes": {
            "Торговая марка": "Evart",
            "Коллекция": "Сабо ЭВА Ола",
            "Тип": "сабо",
            "Модель": "Ола",
            "Материал верха обуви": "ЭВА",
            "Пол": "женский",
            "Размер": "39",
            "Цвет": "серый",
            "Материал подошвы": "ЭВА",
            "Материал стельки": "отсутствует",
            "Стелька": "отсутствует",
            "Подносок": "нет",
            "Защитные свойства": "от общих загрязнений",
            "Метод крепления подошвы": "литьевой",
            "С ремешком": "да",
            "Перфорация": "Да",
            "Тип подошвы": "плоская",
            "Сфера применения": "медицина , пищевое производство и общественное питание , хорека",
            "Стандарты": "ТР ТС 017/2011",
            "Честный знак": "Да",
            "Количество единиц продаж в транспортной упаковке": "1",
            "Страна происхождения": "Россия",
            "Вес": "0.227 кг"
        },
        "result": [
            "Торговая марка",
            "Коллекция",
            "Тип",
            "Модель",
            "Материал верха обуви",
            "Пол",
            "Размер"
        ]
    },
    {
        "title": "Бумага для цветной лазерной печати Xerox Colotech + ( A4, 250 г/кв.м, 250 листов, 003R94671)",
        "attributes": {
            "Торговая марка": "Xerox Colotech +",
            "Покрытие": "без покрытия (каландрированная бумага)",
            "Плотность листа бумаги": "250 г/кв.м",
            "Белизна CIE": "161 ± 3%",
            "Формат листов": "А4",
            "Сертификация по экологическим стандартам": "Нет",
            "Яркость бумаги": "110",
            "Количество единиц продаж в транспортной упаковке": "144",
            "Кол-во единиц продаж в промежуточной упаковке (кратность)": "4",
            "Страна происхождения": "Австрия",
            "Количество листов в упаковке": "250 шт"
        },
        "result": [
            "Торговая марка",
            "Плотность листа бумаги",
            "Формат листов",
            "Количество листов в упаковке"
        ]
    },
    {
        "title": "Сервер iRU Rock S2208P (2023193)",
        "attributes": {
            "Торговая марка": "iRU",
            "Количество установленных процессоров": "2 шт.",
            "Максимальное количество процессоров": "2 шт.",
            "Производитель процессора": "Intel",
            "Модель чипсета": "C621",
            "Процессор": "Xeon Silver",
            "Модель процессора": "4210R",
            "Число ядер процессора": "10 шт.",
            "Частота процессора": "2400 мгц",
            "Тип памяти": "DDR4",
            "Объём оперативной памяти": "128 Гб",
            "Количество слотов памяти": "16 шт.",
            "Максимальное количество оперативной памяти": "4096 гб",
            "Тип жесткого диска": "SSD",
            "Интерфейс": "SATA 6 Гбит/с, SAS 12 Гбит/с",
            "Количество установленных дисков": "1",
            "Поддерживаемые уровни RAID": "0, 1, 5, 10",
            "Оптический привод": "нет",
            "Видеокарта": "Aspeed AST2500",
            "Форм-фактор блока": "Plug-in module",
            "Установлено блоков питания": "2",
            "Максимальное количество блоков питания": "2",
            "Блок питания (мощность)": "1000 вт",
            "Сетевой интерфейс": "3xLAN 1000 Мбит/с",
            "Форм-фактор корпуса": "2U",
            "Отсеки 3,5 внешние": "8",
            "Цвет": "черный",
            "Операционная система": "отсутствует",
            "Комплектация": "руководство по эксплуатации",
            "Гарантийный срок": "36 мес",
            "Количество единиц продаж в транспортной упаковке": "1",
            "Страна происхождения": "Россия",
            "Частота оперативной памяти": "2933 МГц",
            "Объем жесткого диска": "отсутствует Гб",
            "Объём SSD диска": "500 Гб",
            "Размер": "647x437x89 мм"
        },
        "result": [
            "Торговая марка"
        ]
    },
    {
        "title": "Набор гелевых ручек Sketch&Art Uni Write.Glitter 8 цветов (толщина линии 1 мм) (20-0309)",
        "attributes": {
            "Торговая марка": "Sketch&Art",
            "Единица продажи": "набор",
            "Цвет чернил": "разноцветный",
            "Количество цветов": "8",
            "Возможность смены стержня": "нет",
            "Количество штук в упаковке": "8",
            "Кол-во единиц продаж в промежуточной упаковке (кратность)": "отсутствует",
            "Количество единиц продаж в транспортной упаковке": "24",
            "Страна происхождения": "Китай",
            "Толщина линии письма": "1 мм"
        },
        "result": [
            "Торговая марка",
            "Единица продажи",
            "Количество цветов",
            "Толщина линии письма"
        ]
    },
    {
        "title": "Шкаф для документов Linkor 147H112 со стеклом (орех линкольн/белый, 800х398х1835 мм)",
        "attributes": {
            "Торговая марка": "Easy To Lead",
            "Коллекция": "Кабинет Linkor",
            "Тип": "шкаф",
            "Цвет покрытия": "белый, орех линкольн",
            "Количество полок (шт)": "8",
            "Замок": "Нет",
            "Материал": "ДСП, стекло",
            "Материал кромки": "ABS-пластик",
            "Материал дверей": "стекло, ЛДСП",
            "Сборка мебели": "бесплатная сборка",
            "Гарантийный срок": "36 мес",
            "Страна происхождения": "Беларусь",
            "Высота": "1835 мм",
            "Ширина": "800 мм",
            "Глубина": "398 мм"
        },
        "result": [
            "Коллекция",
            "Тип",
            "Цвет покрытия",
            "Высота",
            "Ширина",
            "Глубина"
        ]
    }
]
```

#### Промпт

Промпт без изменений.

#### Результат

```json
{
    "TP": 427,
    "FP": 46,
    "FN": 25,
    "Precision": 0.9,
    "Recall": 0.94,
    "F1-score": 0.92
}
```

Количество верных ответов улучшилось также и f1 мера улучшилась.

### Few-shot (7 примеров) с CoT

#### Примеры

Примеры что и в прошлом пункте.

#### Промпт

Промпт был улучшен по сравнению с другими вариантами.

```python
class SimilarityListResponse(BaseModel):
    attributes: List[str] = Field(..., description="Массив характеристик")

parser = PydanticOutputParser(pydantic_object=SimilarityListResponse)

SYSTEM_PROMPT = """
Напиши ключ из характеристики, если сама характеристика присутствует в **названии** товарной позиции.

Примеры:
{examples}

Следуй этим правилам:
- Характеристика должна быть **полностью или частично** иметь фрагмент строки в товарной позиции.
- Подтверждение должно быть точным, косвенно не считается.
- Если значение не в виде булевой единицы, то ищи фрагмент или полное соответствие.
- Ключ должен быть взят из характеристик.

Сопоставь каждую характеристикепо пунктам в формате 'характеристика'-'фрагмент строки'.
Подумай шаг за шагом и сформируй один ответ и без уточненией.

{format_instructions}
""".strip()

USER_PROMPT = """
Товарная позиция: {problem_title}
Характеристики: {problem_decomposition}
""".strip()
```

#### Результаты

```json
{
    "TP": 428,
    "FP": 21,
    "FN": 24,
    "Precision": 0.95,
    "Recall": 0.95,
    "F1-score": 0.95
}
```

Является наиболее подходящим вариантом.

## Подход 2

В рамках данного подхода необходимо написать те характеристики, которые отсутствуют в товарной позиции.

### Few-shot(3 примера)

#### Промпт

```python
SYSTEM_PROMPT = """
Напиши ключи из характеристики, которые отсутствуют в названии товара.

Примеры
{examples}

Следуй этим правилам:
- Характеристика должна быть полностью или частично представлена в товарной позиции.
- Характеристика должна иметь соответвутствующий фрагмент в названии товара.

Выдай ответ в виде массива JSON.

**Не пиши больше ничего кроме ответа.**
""".strip()

USER_PROMPT = """
Название товара: {problem_title}
Характеристики: {problem_decomposition}
""".strip()
```

#### Результат

```json
{
    "TP": 1101,
    "FP": 32,
    "FN": 243,
    "Precision": 0.97,
    "Recall": 0.82,
    "F1-score": 0.89
}
```

### Few-shot с CoT

#### Промпт

```python
class SimilarityListResponse(BaseModel):
    reasoning: str = Field(..., description="Ход мыслей перед генерацией списка")
    attributes: List[str] = Field(..., description="Список ключей характеристик")

parser = PydanticOutputParser(pydantic_object=SimilarityListResponse)

SYSTEM_PROMPT = """
Напиши ключи из характеристики, которые отсутствуют в названии товара.

Примеры
{examples}

Следуй этим правилам:
- Характеристика должна быть полностью или частично представлена в товарной позиции.
- Характеристика должна иметь соответвутствующий фрагмент в названии товара.

{format_instructions}.

**Не пиши больше ничего кроме ответа.**
""".strip()

USER_PROMPT = """
Название товара: {problem_title}
Характеристики: {problem_decomposition}
""".strip()
```

#### Результаты

```json
{
"TP": 997,
"FP": 74,
"FN": 347,
"Precision": 0.93,
"Recall": 0.74,
"F1-score": 0.83
}
```

# Выводы

В рамках выполнения работы были рассмотрены различные способы валидации товарной позиции и ее списка характеристик. \
Наиболее точным способом оказалось извлечение списка характеристик с использованием Few-Shot на 7 примеров и использованием CoT. Результат данного способа достигает 0.95 F1 меры, 0.95 precision и 0.95 recall.